<html>
  <head>
    <title>Joe Chat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="/stylesheet.css" charset="utf-8">
  </head>
  <body>
    <div class="panel panel-primary">
      <div class="panel-heading">
        <span class="glyphicon glyphicon-comment"></span>
        <span>Chat! <span id="user-count"></span> User(s)</span>
        <div class="pull-right">
          <span>Handle: </span>
          <input id="handle" type="text" value="Anonymous">
        </div>
      </div>
      <div id="msgs-wrapper" class="panel-body">
        <!-- <div id="msgs"></div> -->
        <ul id="msgs" class="chat"></ul>
        <a href="#bottom"></a>
      </div>
      <div class="panel-footer">
        <form id="form">
          <input class="form-control" type="text" id="input" placeholder="Send a message"></input>
        </form>
      </div>
    </div>

    <script type="text/javascript">
      window.onload = function(){
        (function(){
          var inFocus;
          var unseenNotifications = 0;
          $(window).focus(function() {
            inFocus = true;
            unseenNotifications = 0;
            $('title').html("Joe Chat")
          });

          $(window).blur(function() {
            inFocus = false;
          });

          var show = function($el){
            return function(msg, sender){
              $el.append("<li class='left clearfix'><div class='chat-body clearfix'><p><strong>" +
                sender + " </strong><br>" + msg + "</p></div><hr></li>");
            }
          }($("#msgs"));

          var ws = new WebSocket('ws://' + window.location.host + window.location.pathname);
          ws.onopen = function() {
            show('websocket opened');
          };
          ws.onclose = function() {
            show('websocket closed');
          };
          ws.onmessage = function(m) {
            var msg = JSON.parse(m.data)
            if (msg['type'] == 'group-message'){
              show(msg.content, msg.sender);
              $("#msgs-wrapper").animate({ scrollTop: $('#msgs-wrapper')[0].scrollHeight }, "slow");
              if (inFocus == false) {
                unseenNotifications++;
                $("title").html("(" + unseenNotifications + ") Joe Chat");
              }
            } else if (msg['type'] == 'status-update') {
              var numUsers = msg.num_users;
              $('#user-count').html(numUsers);
            }
          };

          setInterval(function(){
            ws.send(JSON.stringify({ 'type': 'update-request' }));
          }.bind(this), 500)

          var sender = function(f){
            var input = document.getElementById('input');

            f.onsubmit = function(){
              ws.send(
                JSON.stringify(
                  {
                    'type': 'group-message',
                    'content': input.value,
                    'sender': document.getElementById('handle').value
                  }
                )
              );
              input.value = "";
              return false;
            }
          }(document.getElementById('form'));
        })();
      }
    </script>
  </body>
</html>
